<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analyseur d'Ouvertures Chess.com</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
        }

        .search-section {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        input[type="text"] {
            flex: 1;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
            min-width: 200px;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            padding: 15px 30px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .loading {
            text-align: center;
            padding: 20px;
            font-size: 18px;
            color: #667eea;
        }

        .error {
            background: #fee;
            color: #c00;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .player-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .player-info h2 {
            color: #333;
            margin-bottom: 10px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .stat-label {
            color: #666;
            font-size: 14px;
        }

        .stat-value {
            color: #333;
            font-size: 24px;
            font-weight: bold;
            margin-top: 5px;
        }

        .openings-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 30px;
        }

        @media (max-width: 768px) {
            .openings-section {
                grid-template-columns: 1fr;
            }
        }

        .openings-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .openings-card h3 {
            margin-bottom: 20px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chess-piece {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .white-piece {
            background: white;
            border: 2px solid #333;
        }

        .black-piece {
            background: #333;
            color: white;
        }

        .opening-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }

        .opening-item:hover {
            transform: translateX(5px);
            box-shadow: 0 3px 15px rgba(0, 0, 0, 0.1);
        }

        .opening-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .trap-name {
            color: #c00;
            font-weight: bold;
        }

        .trap-name::before {
            content: '☠️';
            margin-right: 5px;
        }

        .opening-stats {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .opening-stat {
            font-size: 14px;
            color: #666;
        }

        .win-rate {
            color: #28a745;
            font-weight: bold;
        }

        .draw-rate {
            color: #ffc107;
            font-weight: bold;
        }

        .loss-rate {
            color: #dc3545;
            font-weight: bold;
        }

        .progress-bar {
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            margin-top: 8px;
            overflow: hidden;
            display: flex;
        }

        .progress-win {
            background: #28a745;
            height: 100%;
            transition: width 0.3s;
        }

        .progress-draw {
            background: #ffc107;
            height: 100%;
            transition: width 0.3s;
        }

        .progress-loss {
            background: #dc3545;
            height: 100%;
            transition: width 0.3s;
        }

        .no-data {
            text-align: center;
            color: #999;
            padding: 20px;
            font-style: italic;
        }

        .trap-name {
            color: #b10000;
            font-weight: 700;
        }

        .trap-recos {
            margin-top: .4rem;
            border-left: 3px solid #b10000;
            padding-left: .6rem;
        }

        .trap-reco {
            margin: .25rem 0;
            font-size: .92rem;
        }

        .trap-reco-seq {
            font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
            opacity: .9;
        }

        .trap-reco-tip {
            opacity: .85;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>♟️ Analyseur d'Ouvertures Chess.com</h1>
        <p class="subtitle">Découvrez les ouvertures préférées de n'importe quel joueur</p>
        
        <div class="search-section">
            <input type="text" id="username" placeholder="Entrez le pseudo Chess.com (ex: hikaru)" />
            <button id="analyzeBtn">Analyser</button>
        </div>
        
        <div id="loading" class="loading" style="display: none;">
            ⏳ Chargement des parties en cours...
        </div>
        
        <div id="error" class="error" style="display: none;"></div>
        
        <div id="playerInfo" style="display: none;"></div>
        
        <div id="openingsSection" class="openings-section" style="display: none;">
            <div class="openings-card">
                <h3>
                    <span class="chess-piece white-piece">♔</span>
                    Ouvertures avec les Blancs
                </h3>
                <div id="whiteOpenings"></div>
            </div>
            
            <div class="openings-card">
                <h3>
                    <span class="chess-piece black-piece">♚</span>
                    Ouvertures avec les Noirs
                </h3>
                <div id="blackOpenings"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { registerEcoOpenings } from './eco-pack-xl.js';
        import { TrapEngine, TRAP_PACK } from './trap-engine.js';
      
        // ------------ ECO MAP DE BASE + PACK XL ------------
        const ECO_OPENINGS = new Map([
          [['e4','e5','Nf3','Nc6','Bb5'].join(' '), 'Espagnole (Ruy Lopez)'],
          [['e4','e5','Nf3','Nc6','Bc4'].join(' '), 'Italienne (Giuoco Piano)'],
          [['e4','e5','Nf3','Nf6'].join(' '), 'Défense Petrov'],
          [['e4','e5','Nf3','Nc6','d4'].join(' '), 'Écossaise'],
          [['e4','e5','Nf3','f5'].join(' '), 'Gambit Letton'],
          [['e4','e5','f4'].join(' '), 'Gambit du Roi'],
          [['e4','e5','Nc3'].join(' '), 'Viennoise'],
          [['e4','e5','Bc4'].join(' '), 'Partie du Fou'],
      
          // Sicilienne
          [['e4','c5'].join(' '), 'Défense Sicilienne'],
          [['e4','c5','Nf3','d6'].join(' '), 'Sicilienne Dragon (setup)'],
          [['e4','c5','Nf3','Nc6'].join(' '), 'Sicilienne Classique'],
          [['e4','c5','Nf3','e6'].join(' '), 'Sicilienne Variante Française'],
          [['e4','c5','Nf3','Nf6'].join(' '), 'Sicilienne Nimzowitsch'],
          [['e4','c5','c3'].join(' '), 'Sicilienne Alapin'],
      
          // Française
          [['e4','e6'].join(' '), 'Défense Française'],
          [['e4','e6','d4','d5'].join(' '), 'Française (Var. principale)'],
          [['e4','e6','d4','d5','e5'].join(' '), 'Française Avance'],
          [['e4','e6','d4','d5','Nc3'].join(' '), 'Française Classique'],
          [['e4','e6','d4','d5','exd5'].join(' '), 'Française Échange'],
      
          // Caro-Kann
          [['e4','c6'].join(' '), 'Défense Caro-Kann'],
          [['e4','c6','d4','d5'].join(' '), 'Caro-Kann (Var. principale)'],
          [['e4','c6','d4','d5','Nc3'].join(' '), 'Caro-Kann Classique'],
          [['e4','c6','d4','d5','e5'].join(' '), 'Caro-Kann Avance'],
      
          // Autres vs e4
          [['e4','d5'].join(' '), 'Défense Scandinave'],
          [['e4','d6'].join(' '), 'Défense Pirc'],
          [['e4','Nf6'].join(' '), 'Défense Alekhine'],
          [['e4','g6'].join(' '), 'Défense Moderne'],
          [['e4','Nc6'].join(' '), 'Défense Nimzowitsch'],
          [['e4','a6'].join(' '), 'Défense St. George'],
          [['e4','b6'].join(' '), 'Défense Owen'],
      
          // d4
          [['d4','d5'].join(' '), 'Partie du Pion Dame'],
          [['d4','d5','c4'].join(' '), 'Gambit Dame'],
          [['d4','d5','c4','dxc4'].join(' '), 'Gambit Dame Accepté'],
          [['d4','d5','c4','e6'].join(' '), 'Gambit Dame Refusé'],
          [['d4','d5','c4','c6'].join(' '), 'Défense Slave'],
          [['d4','d5','Nf3'].join(' '), 'Système de Londres (ordre flexible)'],
          [['d4','d5','Bf4'].join(' '), 'Système de Londres (avec Bf4)'],
      
          // Indiennes
          [['d4','Nf6'].join(' '), 'Défenses Indiennes'],
          [['d4','Nf6','c4','e6'].join(' '), 'Nimzo/Ouest-Indienne (set-up)'],
          [['d4','Nf6','c4','g6'].join(' '), 'Est-Indienne (set-up)'],
          [['d4','Nf6','c4','e6','Nc3','Bb4'].join(' '), 'Défense Nimzo-Indienne'],
          [['d4','Nf6','c4','e6','Nf3','b6'].join(' '), 'Défense Ouest-Indienne'],
          [['d4','Nf6','c4','c5'].join(' '), 'Défense Benoni Moderne'],
          [['d4','Nf6','Nf3','g6'].join(' '), 'Est-Indienne (avec Nf3)'],
      
          // Autres d4
          [['d4','f5'].join(' '), 'Défense Hollandaise'],
          [['d4','e6'].join(' '), 'Française par transposition'],
          [['d4','g6'].join(' '), 'Moderne vs d4'],
          [['d4','d6'].join(' '), 'Old Indian'],
          [['d4','c5'].join(' '), 'Benoni Ancienne'],
      
          // Anglaise, Réti et co
          [['c4'].join(' '), 'Ouverture Anglaise'],
          [['c4','e5'].join(' '), 'Anglaise Symétrique (réponse e5)'],
          [['c4','c5'].join(' '), 'Anglaise Symétrique (Sicilienne inversée)'],
          [['c4','Nf6'].join(' '), 'Anglaise avec Nf6'],
          [['c4','e6'].join(' '), 'Anglaise avec e6'],
      
          [['Nf3'].join(' '), 'Ouverture Réti'],
          [['Nf3','d5'].join(' '), 'Réti avec d5'],
          [['Nf3','Nf6'].join(' '), 'Réti Symétrique'],
          [['Nf3','d5','c4'].join(' '), 'Gambit Réti'],
      
          [['f4'].join(' '), 'Ouverture Bird'],
          [['b3'].join(' '), 'Ouverture Larsen'],
          [['g3'].join(' '), 'Ouverture Benko (fianchetto)'],
          [['Nc3'].join(' '), 'Ouverture Van Geet'],
          [['e3'].join(' '), "Ouverture Van't Kruijs"],
          [['b4'].join(' '), 'Ouverture Polonaise'],
        ]);
      
        // Injecte le pack XL + pièges
        registerEcoOpenings(ECO_OPENINGS, { includeTraps: true });

        const trapEngine = new TrapEngine();
        trapEngine.register(TRAP_PACK);
      
        // ------------ FALLBACK 1er COUP ------------
        const FIRST_MOVE_FALLBACK = new Map([
          ['e4','Ouvertures ouvertes (1.e4)'],
          ['d4','Ouvertures fermées (1.d4)'],
          ['c4','Ouverture Anglaise'],
          ['Nf3','Ouverture Réti'],
          ['f4','Ouverture Bird'],
          ['b3','Ouverture Larsen'],
          ['g3','Fianchetto (type Réti/Anglaise)'],
          ['Nc3','Ouverture Van Geet'],
          ['e3',"Ouverture Van't Kruijs"],
          ['b4','Ouverture Polonaise'],
        ]);
      
        // ------------ UTILS GÉNÉRAUX ------------
        const FR = new Intl.DisplayNames(['fr'], { type: 'region' });
      
        function escapeHtml(str) {
          return String(str).replace(/[&<>"']/g, s =>
            ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s])
          );
        }
      
        function parsePgnTags(pgn) {
          const tags = {};
          const re = /\[(\w+)\s+"([^"]*)"\]/g;
          let m;
          while ((m = re.exec(pgn)) !== null) tags[m[1]] = m[2];
          return tags;
        }
      
        function getCountryNameFromUrl(url) {
          try {
            if (!url) return 'N/A';
            const code = url.split('/').pop();
            return code ? (FR.of(code) || code) : 'N/A';
          } catch {
            return 'N/A';
          }
        }
      
        function withTimeout(ms, signal) {
          const ctrl = new AbortController();
          const onAbort = () => ctrl.abort();
          if (signal) signal.addEventListener('abort', onAbort, { once: true });
          const t = setTimeout(() => ctrl.abort(), ms);
          const cleanup = () => clearTimeout(t);
          return { signal: ctrl.signal, cleanup };
        }
      
        // ------------ PGN → TOKENS ------------
        function normalizeToTokens(pgn) {
          if (!pgn || typeof pgn !== 'string') return [];
      
          let s = pgn
            .replace(/\{[^}]*\}/g, ' ')     // commentaires
            .replace(/;.*/g, ' ')           // ; jusqu’à fin de ligne
            .replace(/\([^)]*\)/g, ' ')     // variantes
            .replace(/\$\d+/g, ' ');        // NAGs
      
          s = s.replace(/\b(1-0|0-1|1\/2-1\/2|\*)\b/g, ' ');
          s = s.replace(/\d+\.(\.\.)?/g, ' ');
          s = s.replace(/x/g, '');
          s = s.replace(/[+#]/g, '');
          s = s.replace(/=([QRNB])\b/g, '');
          s = s.replace(/\s+/g, ' ').trim();
      
          if (!s) return [];
      
          const tokens = s.split(' ').filter(tok =>
            /^[O0]-O(-O)?$/.test(tok) ||
            /^[KQRNB]?[a-h]?[1-8]?[a-h][1-8]$/.test(tok) ||
            /^[a-h][1-8]$/.test(tok) ||
            /^[KQRNB][a-h][1-8]$/.test(tok)
          ).map(tok => tok.replace(/^0-0$/, 'O-O').replace(/^0-0-0$/, 'O-O-O'));
      
          return tokens;
        }
      
        // ------------ MATCHING OUVERTURE ------------
        function longestOpeningMatch(tokens) {
          if (!tokens.length) return null;
          const MAX_PLIES = Math.min(tokens.length, 20);
          for (let plies = MAX_PLIES; plies >= 2; plies--) {
            const prefix = tokens.slice(0, plies).join(' ');
            if (ECO_OPENINGS.has(prefix)) return ECO_OPENINGS.get(prefix);
            for (const [pattern, name] of ECO_OPENINGS.entries()) {
              if (prefix === pattern || prefix.startsWith(pattern + ' ')) return name;
            }
          }
          return null;
        }
      
        // Retourne un objet { label, isTrap }
        function getOpeningLabel(pgn) {
          const tags = parsePgnTags(pgn || '');
          // 1) Si PGN donne l'info, on la prend direct
          if (tags.Opening) {
            const label = tags.Variation ? `${tags.Opening}, ${tags.Variation}` : tags.Opening;
            return { label, isTrap: /^Piège:/i.test(label) };
          }
          // 2) Sinon fallback SAN
          const tokens = normalizeToTokens(pgn);
          if (!tokens.length) return { label: 'Ouverture inconnue', isTrap: false };
      
          let label = longestOpeningMatch(tokens);
          if (!label) {
            const first = tokens[0];
            if (FIRST_MOVE_FALLBACK.has(first)) label = FIRST_MOVE_FALLBACK.get(first);
            else if (first === 'O-O' || first === 'O-O-O') label = 'Ouverture avec roque rapide';
            else label = 'Ouverture inconnue';
          }
          return { label, isTrap: /^Piège:/i.test(label) };
        }
      
        // ------------ FETCH & ANALYSE ------------
        const MONTHS_TO_CHECK = 3;
        const FETCH_TIMEOUT_MS = 10000;
      
        async function analyzePlayer() {
          const usernameInput = document.getElementById('username');
          const btn = document.getElementById('analyzeBtn');
          const username = usernameInput.value.trim();
          if (!username) return showError('Veuillez entrer un pseudo Chess.com');
      
          hideError();
          showLoading();
          hideResults();
          btn.disabled = true;
      
          try {
            // Player + stats en parallèle
            const base = `https://api.chess.com/pub/player/${encodeURIComponent(username)}`;
            const { signal, cleanup } = withTimeout(FETCH_TIMEOUT_MS);
            const [playerRes, statsRes] = await Promise.all([
              fetch(base, { signal }),
              fetch(`${base}/stats`, { signal }),
            ]);
            cleanup();
      
            if (!playerRes.ok) throw new Error('Joueur non trouvé');
            const playerData = await playerRes.json();
            const statsData = statsRes.ok ? await statsRes.json() : {};
      
            // Archives des N derniers mois en parallèle
            const now = new Date();
            const months = Array.from({ length: MONTHS_TO_CHECK }, (_, i) => {
              const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
              return { y: d.getFullYear(), m: String(d.getMonth() + 1).padStart(2, '0') };
            });
      
            const monthFetches = months.map(({ y, m }) => {
              const { signal, cleanup } = withTimeout(FETCH_TIMEOUT_MS);
              return fetch(`https://api.chess.com/pub/player/${encodeURIComponent(username)}/games/${y}/${m}`, { signal })
                .then(r => (cleanup(), r.ok ? r.json() : { games: [] }))
                .catch(() => ({ games: [] }));
            });
      
            const monthPayloads = await Promise.allSettled(monthFetches);
            const recentGames = monthPayloads.flatMap(res => res.status === 'fulfilled' ? (res.value.games || []) : []);
      
            if (!recentGames.length) throw new Error('Aucune partie récente trouvée');
      
            // Filtrer parties standard (pas chess960 etc.)
            const games = recentGames.filter(g => g.rules ? g.rules === 'chess' : true);
      
            // Stats par couleurs via Map, clés = label propre (pas de HTML)
            const whiteMap = new Map();
            const blackMap = new Map();
      
            for (const game of games) {
              if (!game.pgn) continue;
      
              const youAreWhite = game.white && game.white.username && String(game.white.username).toLowerCase() === username.toLowerCase();
      
              // Résultat côté "toi"
              let result = 'draw';
              if (game.white?.result === 'win') result = youAreWhite ? 'win' : 'loss';
              else if (game.black?.result === 'win') result = youAreWhite ? 'loss' : 'win';
      
              const { label, isTrap } = getOpeningLabel(game.pgn);
              const key = label; // clé "propre"

              // Camp qui pose le piège = "toi"
              const yourSide = youAreWhite ? 'white' : 'black';

              // Match des pièges vus dans la partie
              const trapScan = trapEngine.matchPgn(game.pgn, { openingLabel: label, side: yourSide, maxPlies: 24 });

              // On peut compter combien de fois tu as placé un piège dans cette ouverture
              if (trapScan.hits.length) {
                // exemple: incrémenter un compteur par label
                const map = youAreWhite ? whiteMap : blackMap;
                const bucket = map.get(label) || { count:0, wins:0, draws:0, losses:0, isTrap:false, traps:[] };
                bucket.traps = bucket.traps || [];
                // On garde 1-2 meilleurs hits
                bucket.traps.push(...trapScan.hits.slice(0,2));
                map.set(label, bucket);
              }

              const map = youAreWhite ? whiteMap : blackMap;
              if (!map.has(key)) map.set(key, { count: 0, wins: 0, draws: 0, losses: 0, isTrap, traps: [] });
              const bucket = map.get(key);
              bucket.count++;
              if (result === 'win') bucket.wins++;
              else if (result === 'draw') bucket.draws++;
              else bucket.losses++;
              // Si une même clé a un jour isTrap true/false, on garde true si l’un des matchs était un piège
              bucket.isTrap = bucket.isTrap || isTrap;
            }
      
            displayPlayerInfo(playerData, statsData);
            displayOpenings(whiteMap, blackMap);
          } catch (err) {
            showError(err.message || 'Erreur inconnue');
          } finally {
            hideLoading();
            btn.disabled = false;
          }
        }
      
        // ------------ UI ------------
        function displayPlayerInfo(playerData, statsData) {
          const playerInfoDiv = document.getElementById('playerInfo');
          const rapid = statsData?.chess_rapid?.last?.rating ?? 'N/A';
          const blitz = statsData?.chess_blitz?.last?.rating ?? 'N/A';
          const bullet = statsData?.chess_bullet?.last?.rating ?? 'N/A';
          const country = getCountryNameFromUrl(playerData.country);
      
          playerInfoDiv.innerHTML = `
            <div class="player-info">
              <h2>${escapeHtml(playerData.username || '')}</h2>
              <div class="stats">
                <div class="stat-card"><div class="stat-label">Rapid</div><div class="stat-value">${rapid}</div></div>
                <div class="stat-card"><div class="stat-label">Blitz</div><div class="stat-value">${blitz}</div></div>
                <div class="stat-card"><div class="stat-label">Bullet</div><div class="stat-value">${bullet}</div></div>
                <div class="stat-card"><div class="stat-label">Pays</div><div class="stat-value">${escapeHtml(country)}</div></div>
              </div>
            </div>
          `;
          playerInfoDiv.style.display = 'block';
        }
      
        function formatOpeningRow(name, stats, isTrap) {
          const winRate = stats.count ? ((stats.wins / stats.count) * 100).toFixed(1) : '0.0';
          const drawRate = stats.count ? ((stats.draws / stats.count) * 100).toFixed(1) : '0.0';
          const lossRate = stats.count ? ((stats.losses / stats.count) * 100).toFixed(1) : '0.0';
          const safeName = escapeHtml(name);
          const labelHtml = isTrap ? `<span class="trap-name">${safeName}</span>` : safeName;
      
          return `
            <div class="opening-item">
              <div class="opening-name">${labelHtml}</div>
              <div class="opening-stats">
                <span class="opening-stat">📊 ${stats.count} parties</span>
                <span class="opening-stat win-rate">✓ ${winRate}%</span>
                <span class="opening-stat draw-rate">= ${drawRate}%</span>
                <span class="opening-stat loss-rate">✗ ${lossRate}%</span>
              </div>
              <div class="progress-bar">
                <div class="progress-win" style="width:${winRate}%"></div>
                <div class="progress-draw" style="width:${drawRate}%"></div>
                <div class="progress-loss" style="width:${lossRate}%"></div>
              </div>
            </div>
          `;
        }
      
        function displayOpenings(whiteMap, blackMap) {
          const whiteDiv = document.getElementById('whiteOpenings');
          const blackDiv = document.getElementById('blackOpenings');
      
          const sortedWhite = [...whiteMap.entries()].sort((a, b) => b[1].count - a[1].count);
          const sortedBlack = [...blackMap.entries()].sort((a, b) => b[1].count - a[1].count);
      
          whiteDiv.innerHTML = sortedWhite.length
            ? sortedWhite.slice(0, 10).map(([name, stats]) => {
                const recs = trapEngine.recommendByOpening(name, 'white', 3);
                return formatOpeningRow(name, stats, stats.isTrap) + (recs.length ? `
<div class="trap-recos">
  ${recs.map(r => `
    <div class="trap-reco">
      <div class="trap-reco-name">💣 ${escapeHtml(r.name)}</div>
      <div class="trap-reco-seq">${escapeHtml(r.seq.join(' '))}</div>
      <div class="trap-reco-tip">💡 ${escapeHtml(r.advice)}</div>
    </div>
  `).join('')}
</div>
` : '');
              }).join('')
            : '<div class="no-data">Aucune donnée disponible</div>';

          blackDiv.innerHTML = sortedBlack.length
            ? sortedBlack.slice(0, 10).map(([name, stats]) => {
                const recs = trapEngine.recommendByOpening(name, 'black', 3);
                return formatOpeningRow(name, stats, stats.isTrap) + (recs.length ? `
<div class="trap-recos">
  ${recs.map(r => `
    <div class="trap-reco">
      <div class="trap-reco-name">💣 ${escapeHtml(r.name)}</div>
      <div class="trap-reco-seq">${escapeHtml(r.seq.join(' '))}</div>
      <div class="trap-reco-tip">💡 ${escapeHtml(r.advice)}</div>
    </div>
  `).join('')}
</div>
` : '');
              }).join('')
            : '<div class="no-data">Aucune donnée disponible</div>';
      
          document.getElementById('openingsSection').style.display = 'grid';
        }
      
        function showLoading() {
          document.getElementById('loading').style.display = 'block';
        }
        function hideLoading() {
          document.getElementById('loading').style.display = 'none';
        }
        function showError(message) {
          const errorDiv = document.getElementById('error');
          errorDiv.textContent = `❌ Erreur : ${message}`;
          errorDiv.style.display = 'block';
        }
        function hideError() {
          document.getElementById('error').style.display = 'none';
        }
        function hideResults() {
          document.getElementById('playerInfo').style.display = 'none';
          document.getElementById('openingsSection').style.display = 'none';
        }
      
        // ------------ EVENTS ------------
        document.getElementById('username').addEventListener('keydown', e => {
          if (e.key === 'Enter') analyzePlayer();
        });
        document.getElementById('analyzeBtn').addEventListener('click', analyzePlayer);
      </script>
      
</body>
</html>
